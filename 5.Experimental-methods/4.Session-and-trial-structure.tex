\section{Session and trial structure}
\label{sec:Session-and-trial-structure}

\subsection{TPLSM experimental pipeline}

An imaging session followed the same process in each experiment, starting with the setting up of a rig.
As a first step, the laser was turned on from its standby mode, about 30 minutes before conducting the scanning. This was the required time for the device to warm up to consistent power levels.

Besides the laser, the objective's motor, connected to the two-photon computer, was also turned on, as well as the heating pad to place the animal on and keep its thermal balance whilst anaesthetized. The laser's shutter was also opened as well as the pockel cells that control the light delivered to the animal's brain. Furthermore, the laser source was shared between two rigs, which meant that at each session one should confirm that the mirrors were rotated to the appropriate angle to send light to the rig being used. Furthermore, the system had two operation modes that could be interchanged with a switcher: Full brightness and two-photon imaging modes. With the PMT off, the experiment was to start with the switch to full brightness mode.

During this time, both the stimuli computer and the two-photon computer were turned on, and the rig was wired to bpod mode. In the stimuli computer, two matlab instances were opened, one for bpod states machine and GUI and another for psychtoolbox's stimuli presentation. In the two-photon computer, Bonsai light contamination control system was put to play, and a matlab instance was opened to start scanImage 4 laser-scanning software control system.

The animal to be imaged was manually removed from its cage and placed in a box to be anaesthetized with isoflurane, initially at $3.5\%$, delivered by a ventilation tube, mixed with oxygen at pressure of $1 atm$. Once the animal was unconscious, the paralyser chlorprothixene ($1 mg/kg$) was injected intramuscularly, and the animal was put back in the anaesthetizing box. At this point, the isoflurane ventilation was switched from the box to the rig's tube and the animal was quickly and carefully moved from the box to a platform in the rig under the objective, over the heating pad, confirmed to be at $34ยบC$, with a mouth piece connected to the anaesthesia tube surrounding its fur. The mouse's headpiece was then locked to fixation screws and the animal's eyes were protected with an uniform layer of eye ointment; the anaesthesia was then set to a $1\%$ value, maintained during the rest of the session.

The cranial window was cleaned with deionized water as well as the objective, with the aid of Thorlab paper for optical components. A black plastic ring was then glued to the cranial window, in order to minimize contamination of the collected fluorescence signals with monitor light. Imaging gel was placed over the cranial window, with care for not keeping air bubbles that could impeach the light path, and for keeping full uniform contact between the gel and the imaging window.

The imaging system was initially in full brightness mode with the PMT turned off. Camera software was then opened and configured in the two-photon computer, to aid with full-brightness mode navigation. With this, a pedal enabled a green light to be sent from the objective, aiding in the alignment of the animal's cranial window within the full range of the objective's motor: the animal's platform was moved to the appropriate objective-aligned placing and the objective was then moved down in depth until reaching the gel and until the software displayed visible blood vessels.
The stimuli presentation monitor was then centred to the animal's right eye gaze, at $15 cm$ from his eye and at a $30ยบ$ angle with its body's axis. Finally, a light shield was placed over the objective and the rubber ring in the animal's cranial window, ensuring good blockage of the monitor's contamination light to the signal's light path. The room's lights were filtered for only passing red light and the rig was then closed with a black cloth to further seclude it from light contamination and PMT damage. 

With the intrinsic azimuth and elevation maps rotated to match the objective's signal display on the camera software, with the green light on, one would then search for the (0,0) corresponding position in V1, using the larger blood vessels as guidelines. Having found this placing, the pedal was left off, and the PMT could be turned on for two-photon mode imaging with the ScanImage software.

The configurations in ScanImage were set to multiplane scanning (5 planes). The laser was calibrated, and the voltage - angle calibration curve was confirmed linear. Bpod was started with a Tuning protocol, with a small-sized circular center grating stimuli being presented in multiple directions and frequencies, to further aid in searching for V1 (0,0) position. Bpod setting's were submitted, and psychtoolbox protocol could be initiated, preparing the stimuli.

The scanning could be started with ScanImage GUI set to expect no external triggering, for continuous signal collection through time. The green channel's signal for each imaged plane could then be seen, in ScanImage GUI. Going down in depth, one starts to detect the dura of the brain. At this point, the motor coordinates should be set to zero. 
In these experiment, one would go further down to $150 \mu m$ to $210 \mu m$ center plane depth, until neurons could be detected.

Once the stimuli masks were ready, the \textit{Start} button in bpod's GUI initiated the stimuli presentation. With this small centred stimuli being displayed to the mouse, one could then search for the close positions in the mouse's brain that were more strongly responding with locked timings to the stimuli presentation. 

Having found this position, the recordings were started, fixed to external triggering coming from bpod's device. A reference image was print screened and kept for checking and managing possible drift of the imaging planes during the session, due to cranial window or brain micro movements. During the session, one should also keep checking the trial number synchronization between scan image recordings, psychtoolbox presentation and bpod triggers, in both computer GUIs.

\subsection{Stimuli presentation structure}

The experimental recorded stimuli presentation of a session comprised three main protocols for each mouse and each of that animal's V1 imaged position: A protocol to establish the receptive fields of the imaged neurons ($\texttt{StimPresProt\_RF}$), another to regard their tuning properties ($\texttt{StimPresProt\_tuning}$) and a last protocol designed for the actual surround modulation examinations ($\texttt{StimPresProt\_RF}$). 

Each protocol involved a pseudorandomized sequence of trials - N repetitions of X trial types. Repetitions of each stimulus type are required in order to enhance the signal to noise ratio of the responses by trial averaging. 

In general, each trial was formed by an initial baseline, a stimulus presentation, and an inter-trial interval (ITI). In both the baseline and the ITI the screen was left at background brightness and contrast level (grey) and its duration was used as buffer time for internal computations and to ensure sufficient Calcium decay from the previous stimulation (from the previous trial in the case of the baseline, and from the same trial in the case of the ITI). A session's total stimuli display duration should not be longer than two hours, as the anesthesia produces cumulative effects in the central nervous system and can start depressing the neuronal responses, impeaching the subsequent study of its relation with the visual stimulation [REFERENCES]. Thus, the durations of these intervals depended on the specific protocol (chapter 4, section d), as a balance between how important was the separation of responses in between trials - the more precise the intended separation, the larger should be the baseline and ITI durations - and how many trial types and trial repetitions were intended - the more trials, the less duration the baseline and ITI should have.

 \begin{table}[H]
\begin{center}\par
\scalebox{0.85}{
\begin{tabular}{c|cccccccccccccccccccccccccc}
\hline 
 
    
           & \multicolumn{ 1}{c}{Number of trial types} & Number of repetitions &     baseline (ms) & stimulus (ms)& ITI (ms) \\
           
           \hline
           \hline

RF & 80 & 14 & 0 & 880 & 120 \\
tuning & 32 & 25 & 5 & 900 & 95 \\
SM & 124 & 15-20 & 500 & 1000 & 500 \\

\hline
        
\end{tabular}}
 \caption{Protocol configurations regarding session extension and trial durations.}
    \vspace{-5mm}
    \label{table:times}
\end{center}
\end{table}